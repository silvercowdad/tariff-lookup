<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ü§ñ US Tariff Lookup - FTA-Aware Automation</title>

  <!-- Chart.js (optional, for history chart) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 380px 1fr 350px;
      gap: 20px;
    }

    @media (max-width: 1400px) {
      .container { grid-template-columns: 1fr 350px; }
      .history-sidebar { display: none !important; }
    }

    @media (max-width: 1024px) {
      .container { grid-template-columns: 1fr; }
      .news-sidebar { display: none !important; }
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    h1 {
      color: #1a202c;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #718096;
      font-size: 14px;
      margin-bottom: 14px;
    }

    .fta-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 10px;
    }

    .api-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 14px;
      background: #d1fae5;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 700;
      color: #065f46;
      margin-bottom: 14px;
      border: 2px solid #a7f3d0;
    }

    .api-left {
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .api-status .dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
      flex: 0 0 auto;
    }

    @keyframes pulse { 0%,100% {opacity:1;} 50% {opacity:0.5;} }

    .api-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta-line {
      font-size: 11px;
      color: #065f46;
      opacity: 0.9;
      margin-top: 2px;
      font-weight: 700;
    }

    .api-actions {
      display:flex;
      gap:10px;
      flex: 0 0 auto;
    }

    .mini-btn {
      padding: 8px 10px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(30,60,114,0.25);
    }

    .mini-btn:hover { transform: translateY(-1px); }

    .search-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 12px;
    }

    label {
      display:block;
      margin-bottom:8px;
      color:#2d3748;
      font-weight:700;
      font-size:14px;
    }

    input, select {
      width:100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.2s;
      background: #f7fafc;
    }

    input:focus, select:focus {
      outline:none;
      border-color:#1e3c72;
      background:white;
      box-shadow:0 0 0 3px rgba(30,60,114,0.1);
    }

    .hs-code-input {
      font-family: 'Courier New', monospace;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 1px;
    }

    .hs-helper {
      font-size: 11px;
      color: #64748b;
      margin-top: 4px;
      font-weight: 700;
    }

    #ftaStatus {
      margin-top: 8px;
      font-size: 12px;
      font-weight: 800;
    }

    .checkbox-group {
      margin-top: 12px;
      padding: 14px;
      background: #f0f9ff;
      border-radius: 10px;
      border: 2px solid #bae6fd;
    }

    .checkbox-group label {
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      font-size:14px;
      margin-bottom:0;
      font-weight:800;
      color:#0f172a;
    }

    input[type="checkbox"] { width: 20px; height: 20px; cursor:pointer; }

    .main-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 17px;
      font-weight: 800;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(30,60,114,0.3);
      margin-top: 12px;
    }

    .main-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(30,60,114,0.4); }

    .loading { display:none; text-align:center; padding: 24px; }
    .loading.show { display:block; }
    .spinner {
      border:4px solid #f3f3f3;
      border-top:4px solid #1e3c72;
      border-radius:50%;
      width:50px; height:50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

    .results-card { display:none; }
    .results-card.show { display:block; animation: slideIn 0.35s; }
    @keyframes slideIn { from {opacity:0; transform: translateY(12px);} to {opacity:1; transform: translateY(0);} }

    .results-header {
      display:flex;
      justify-content: space-between;
      align-items:center;
      margin-bottom: 18px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e2e8f0;
    }

    .total-badge {
      padding: 12px 24px;
      background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      color: white;
      border-radius: 25px;
      font-size: 24px;
      font-weight: 900;
      box-shadow: 0 4px 15px rgba(245,101,101,0.3);
    }
    .total-badge.zero { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }

    .info-box {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-left: 4px solid #0284c7;
      padding: 18px;
      border-radius: 8px;
      margin-bottom: 18px;
    }
    .info-row { display:flex; justify-content: space-between; padding: 7px 0; font-size: 15px; }
    .info-label { color:#0369a1; font-weight:800; }
    .info-value { color:#075985; font-weight:900; }

    .tariff-item {
      background:#f7fafc;
      border:2px solid #e2e8f0;
      border-radius:12px;
      padding:18px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    .tariff-item:hover { border-color:#1e3c72; box-shadow: 0 4px 15px rgba(30,60,114,0.1); }
    .tariff-item.free { border-color:#10b981; background:#f0fdf4; }

    .tariff-header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; }
    .tariff-name { font-size: 16px; font-weight: 900; color:#2d3748; }
    .tariff-rate { font-size: 28px; font-weight: 900; color:#e53e3e; }
    .tariff-rate.zero { color:#10b981; }

    .tariff-description { font-size: 14px; color:#4a5568; line-height: 1.6; margin-top: 6px; }

    .tag {
      display:inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      margin-left: 8px;
    }
    .tag.fta { background:#d1fae5; color:#065f46; }
    .tag.mfn { background:#dbeafe; color:#1e40af; }
    .tag.ieepa { background:#e9d5ff; color:#6b21a8; }
    .tag.section232 { background:#fee2e2; color:#991b1b; }
    .tag.section301 { background:#fef3c7; color:#92400e; }

    .warning-box {
      background:#fef3c7;
      border:2px solid #fbbf24;
      border-radius: 12px;
      padding: 16px;
      margin-top: 14px;
    }
    .warning-title { font-weight: 900; color:#92400e; margin-bottom: 8px; font-size: 15px; }

    .exemption-box {
      background:#d1fae5;
      border:2px solid #10b981;
      border-radius: 12px;
      padding: 16px;
      margin-top: 14px;
    }
    .exemption-title { font-weight: 900; color:#065f46; margin-bottom: 8px; font-size: 15px; }

    .history-card, .news-card {
      background:white;
      border-radius:16px;
      padding: 22px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .chart-container { position: relative; height: 280px; margin-bottom: 14px; }

    .news-item {
      background:#f7fafc;
      border-left: 4px solid #3b82f6;
      padding: 14px;
      margin-bottom: 12px;
      border-radius: 8px;
    }
    .news-item.urgent { border-left-color:#ef4444; }
    .news-headline { font-size:14px; font-weight: 900; color:#1e293b; margin-bottom: 4px; }
    .news-date { font-size:11px; color:#64748b; font-weight: 800; margin-bottom: 4px; }

    .muted {
      color:#94a3b8;
      font-size: 13px;
      text-align:center;
      padding: 22px 10px;
      font-weight: 800;
    }

    footer {
      text-align:center;
      color:white;
      margin-top: 30px;
      opacity: 0.9;
      font-size: 13px;
      grid-column: 1 / -1;
      font-weight: 800;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- History Sidebar -->
    <div class="history-sidebar">
      <div class="history-card">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:14px; padding-bottom:12px; border-bottom:2px solid #e2e8f0;">
          <span style="font-size:24px;">üìà</span>
          <span style="font-size:18px; font-weight:900; color:#1a202c;">Tariff History</span>
        </div>

        <div class="chart-container">
          <canvas id="tariffChart"></canvas>
        </div>

        <div id="timelineList">
          <p class="muted">Search to view tariff history</p>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div style="display:flex; flex-direction:column; gap:20px;">
      <div class="card">
        <h1>ü§ñ US Tariff Lookup</h1>
        <p class="subtitle">
          FTA-Aware Automation ‚Ä¢ Rules via JSON
          <span class="fta-badge">‚úì LIVE RULES</span>
        </p>

        <!-- ‚úÖ These two IDs are used by JS -->
        <div class="api-status">
          <div class="api-left">
            <span class="dot"></span>
            <div style="min-width:0;">
              <div class="api-text" id="apiStatusText">Loading rules...</div>
              <div class="meta-line" id="rulesMeta">Rules: updating...</div>
            </div>
          </div>
          <div class="api-actions">
            <button class="mini-btn" onclick="refreshRules(true)">‚¨áÔ∏è Update</button>
          </div>
        </div>

        <div class="search-section">
          <div>
            <label for="origin">üåç Country of Origin</label>
            <select id="origin" onchange="updateFtaStatus()">
              <option value="">Select Country</option>

              <optgroup label="üü¢ FTA Countries (Special Rules)">
                <option value="KR">üá∞üá∑ South Korea (KORUS - Minimum rule)</option>
                <option value="MX">üá≤üáΩ Mexico (USMCA - Conditional)</option>
                <option value="CA">üá®üá¶ Canada (USMCA - Conditional)</option>
              </optgroup>

              <optgroup label="üü¢ FTA Countries (Standard 0%)">
                <option value="SG">üá∏üá¨ Singapore</option>
                <option value="AU">üá¶üá∫ Australia</option>
                <option value="IL">üáÆüá± Israel</option>
                <option value="JO">üáØüá¥ Jordan</option>
                <option value="MA">üá≤üá¶ Morocco</option>
                <option value="CL">üá®üá± Chile</option>
                <option value="PE">üáµüá™ Peru</option>
                <option value="CO">üá®üá¥ Colombia</option>
                <option value="PA">üáµüá¶ Panama</option>
                <option value="BH">üáßüá≠ Bahrain</option>
                <option value="OM">üá¥üá≤ Oman</option>
                <option value="CR">üá®üá∑ Costa Rica (CAFTA-DR)</option>
                <option value="DO">üá©üá¥ Dominican Republic (CAFTA-DR)</option>
                <option value="SV">üá∏üáª El Salvador (CAFTA-DR)</option>
                <option value="GT">üá¨üáπ Guatemala (CAFTA-DR)</option>
                <option value="HN">üá≠üá≥ Honduras (CAFTA-DR)</option>
                <option value="NI">üá≥üáÆ Nicaragua (CAFTA-DR)</option>
              </optgroup>

              <optgroup label="üî¥ No FTA">
                <option value="CN">üá®üá≥ China</option>
                <option value="VN">üáªüá≥ Vietnam</option>
                <option value="JP">üáØüáµ Japan</option>
                <option value="TW">üáπüáº Taiwan</option>
                <option value="MY">üá≤üáæ Malaysia</option>
                <option value="IN">üáÆüá≥ India</option>
                <option value="TH">üáπüá≠ Thailand</option>
              </optgroup>
            </select>

            <!-- ‚úÖ Used by JS -->
            <div id="ftaStatus"></div>
          </div>

          <div>
            <label for="hsCode">üì¶ HS Code (6-10 digits)</label>
            <input
              type="text"
              id="hsCode"
              class="hs-code-input"
              placeholder="8507600010"
              maxlength="10"
            />
            <div class="hs-helper">üí° Example: 0010 = auto battery, 0020 = other</div>
          </div>
        </div>

        <!-- ‚úÖ Used by JS -->
        <div id="usmcaCheckbox" style="display:none;">
          <div class="checkbox-group">
            <label>
              <input type="checkbox" id="usmcaCompliant" />
              <span>‚úÖ USMCA Certificate of Origin available (Rules of Origin met)</span>
            </label>
            <div style="font-size:11px; color:#64748b; margin-top:8px; margin-left:30px; font-weight:800;">
              If unchecked: MFN + reciprocal applies
            </div>
          </div>
        </div>

        <button class="main-btn" onclick="lookupTariff()">üîé Calculate Accurate Tariff</button>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p style="margin-top:14px; color:#4a5568; font-weight:900;">
            Processing rules...<br />
            <span style="font-size:12px; color:#718096; font-weight:800;">
              Load once on refresh + auto refresh every hour
            </span>
          </p>
        </div>
      </div>

      <!-- Results -->
      <div class="card results-card" id="results">
        <div class="results-header">
          <div style="font-size:22px; color:#1a202c; font-weight:900;">Tariff Calculation</div>
          <div class="total-badge" id="totalRate">0%</div>
        </div>

        <div class="info-box">
          <div class="info-row">
            <span class="info-label">HS Code</span>
            <span class="info-value" id="displayHsCode">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Product</span>
            <span class="info-value" id="productCategory">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">Origin</span>
            <span class="info-value" id="displayOrigin">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">FTA Status</span>
            <span class="info-value" id="ftaStatusResult">-</span>
          </div>
        </div>

        <div style="margin-top:18px;">
          <div style="font-size:18px; font-weight:900; color:#1a202c; margin-bottom:12px;">üìä Tariff Breakdown</div>
          <div id="tariffItems"></div>
        </div>

        <div id="exemptionContainer"></div>
        <div id="warningContainer"></div>
      </div>
    </div>

    <!-- News Sidebar -->
    <div class="news-sidebar">
      <div class="news-card">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:14px; padding-bottom:12px; border-bottom:2px solid #e2e8f0;">
          <span style="font-size:24px;">üì∞</span>
          <span style="font-size:18px; font-weight:900; color:#1a202c;">Rule Updates</span>
        </div>
        <div id="newsContent"></div>
      </div>
    </div>

    <footer>
      <p>‚ö° FTA-Aware Automation ‚Ä¢ rules.json fetch on load + hourly refresh ‚Ä¢ Update button supported</p>
      <p style="margin-top:6px; font-size:11px;">Tip: update tariff-rules.json on GitHub ‚Üí users refresh or click Update</p>
    </footer>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const RULES_URL = "./tariff-rules.json";
    const AUTO_REFRESH_MS = 60 * 60 * 1000; // 1 hour = 3,600,000ms (ÎçîÎ∏îÏ≤¥ÌÅ¨ ÏôÑÎ£å)
    const HISTORY_KEY = "tariff_lookup_history_v1";
    const HISTORY_MAX = 12;

    function urlNoCache(url) {
      const sep = url.includes("?") ? "&" : "?";
      return url + sep + "v=" + Date.now();
    }

    // =========================
    // RULES (fetched)
    // =========================
    let RULES = null;

    const FALLBACK_RULES = {
      meta: { rulesVersion: "fallback", updatedAt: null, statusText: "Fallback rules (fetch failed)" },
      ftaCountries: {},
      countries: {},
      hsCodeRules: {},
      mfnRates: {},
      reciprocalRates: { DEFAULT: 0.10 },
      productDescriptions: {},
      news: []
    };

    async function refreshRules(showAlertOnFailure = false) {
      const statusEl = document.getElementById("apiStatusText");
      const metaEl = document.getElementById("rulesMeta");

      if (statusEl) statusEl.textContent = "Updating rules from internet...";
      if (metaEl) metaEl.textContent = "Rules: updating...";

      try {
        const res = await fetch(urlNoCache(RULES_URL), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const json = await res.json();

        // minimum schema check
        if (!json || !json.ftaCountries || !json.mfnRates || !json.reciprocalRates) {
          throw new Error("Invalid rules schema (need ftaCountries/mfnRates/reciprocalRates)");
        }

        RULES = json;

        const version = RULES.meta?.rulesVersion ?? "(no version)";
        const updatedAt = RULES.meta?.updatedAt ?? "(no updatedAt)";
        const statusText = RULES.meta?.statusText ?? "Rules loaded ‚úì";

        if (statusEl) statusEl.textContent = statusText;
        if (metaEl) metaEl.textContent = `Rules loaded ‚úì version=${version} ‚Ä¢ updatedAt=${updatedAt}`;

        // refresh UI after rules load
        updateFtaStatus();
        displayNews();

        return true;
      } catch (err) {
        RULES = FALLBACK_RULES;
        if (statusEl) statusEl.textContent = "Rule fetch failed (fallback)";
        if (metaEl) metaEl.textContent = "Rules: fetch failed ‚úó using fallback rules";
        if (showAlertOnFailure) alert("Rules update failed: " + err.message);
        return false;
      }
    }

    // =========================
    // DATA ACCESSORS
    // =========================
    function getFTACountry(code) {
      return RULES?.ftaCountries?.[code] || null;
    }

    function getCountryLabel(code) {
      return RULES?.countries?.[code] || code;
    }

    function getHsRule(hsCode10) {
      return RULES?.hsCodeRules?.[hsCode10] || null;
    }

    function getMFNRate(hsCode) {
      const k6 = hsCode.substring(0, 6);
      const k4 = hsCode.substring(0, 4);
      const r6 = RULES?.mfnRates?.[k6];
      if (typeof r6 === "number") return r6;
      const r4 = RULES?.mfnRates?.[k4];
      if (typeof r4 === "number") return r4;
      return 0.10; // default
    }

    function getReciprocalRate(countryCode) {
      const r = RULES?.reciprocalRates?.[countryCode];
      if (typeof r === "number") return r;
      const d = RULES?.reciprocalRates?.DEFAULT;
      if (typeof d === "number") return d;
      return 0.10; // default
    }

    function getProductDescription(hsCode) {
      const hs10 = hsCode.padEnd(10, "0");
      const rule = getHsRule(hs10);
      if (rule?.description) return rule.description;

      const k4 = hsCode.substring(0, 4);
      return RULES?.productDescriptions?.[k4] || `HS Code ${hsCode}`;
    }

    function formatHsCode(code) {
      if (code.length === 10) return code.substring(0, 4) + '.' + code.substring(4, 6) + '.' + code.substring(6, 10);
      if (code.length >= 6) return code.substring(0, 4) + '.' + code.substring(4, 6);
      return code;
    }

    // =========================
    // UI HELPERS
    // =========================
    function updateFtaStatus() {
      const origin = document.getElementById('origin').value;
      const ftaStatus = document.getElementById('ftaStatus');
      const usmcaCheckbox = document.getElementById('usmcaCheckbox');

      if (!origin) {
        ftaStatus.textContent = '';
        ftaStatus.style.color = '#059669';
        usmcaCheckbox.style.display = 'none';
        return;
      }

      const ftaInfo = getFTACountry(origin);

      if (ftaInfo) {
        if (ftaInfo.type === 'conditional') {
          ftaStatus.textContent = `‚úì ${ftaInfo.fta} - ${ftaInfo.description}`;
          ftaStatus.style.color = '#059669';
          usmcaCheckbox.style.display = 'block';
        } else if (ftaInfo.type === 'minimum') {
          ftaStatus.textContent = `‚ö†Ô∏è ${ftaInfo.fta} - ${ftaInfo.description}`;
          ftaStatus.style.color = '#d97706';
          usmcaCheckbox.style.display = 'none';
        } else {
          ftaStatus.textContent = `‚úì ${ftaInfo.fta} - ${ftaInfo.description}`;
          ftaStatus.style.color = '#059669';
          usmcaCheckbox.style.display = 'none';
        }
      } else {
        ftaStatus.textContent = '‚ùå No FTA - Full tariffs apply';
        ftaStatus.style.color = '#dc2626';
        usmcaCheckbox.style.display = 'none';
      }
    }

    function displayNews() {
      const el = document.getElementById('newsContent');
      if (!el) return;

      const version = RULES?.meta?.rulesVersion ?? "(no version)";
      const updatedAt = RULES?.meta?.updatedAt ?? "(no updatedAt)";

      const items = (RULES?.news && Array.isArray(RULES.news) && RULES.news.length)
        ? RULES.news
        : [
            {
              date: updatedAt,
              headline: "Rules loaded",
              body: `Using rules version ${version}. Update tariff-rules.json to push changes.`
            }
          ];

      el.innerHTML = items.map((n, i) => `
        <div class="news-item ${i === 0 ? 'urgent' : ''}">
          <div class="news-date">${escapeHtml(n.date || '')}</div>
          <div class="news-headline">${escapeHtml(n.headline || '')}</div>
          <div style="font-size:13px; color:#475569; line-height:1.5; margin-top:5px; font-weight:700;">
            ${escapeHtml(n.body || '')}
          </div>
        </div>
      `).join('');
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // =========================
    // TARIFF CALC
    // =========================
    function calculateAccurateTariff(hsCode, countryCode, usmcaCompliant = false) {
      const hsCode10 = hsCode.padEnd(10, '0');
      const hsRule = getHsRule(hsCode10);
      const ftaInfo = getFTACountry(countryCode);

      let tariffItems = [];
      let totalRate = 0;
      let warnings = [];
      let exemptions = [];
      let ftaStatusText = 'No FTA';

      const description = getProductDescription(hsCode);
      const mfnRate = getMFNRate(hsCode);

      if (ftaInfo) {
        ftaStatusText = ftaInfo.fta;

        // CASE 1: Conditional (USMCA)
        if (ftaInfo.type === 'conditional') {
          if (usmcaCompliant) {
            tariffItems.push({
              name: `${ftaInfo.fta} - Duty Free`,
              rate: 0,
              tag: 'fta',
              description: 'Certificate of Origin: Rules of Origin met',
              source: ftaInfo.fta
            });
            exemptions.push(`‚úÖ ${ftaInfo.fta}: Waived with valid Certificate of Origin`);
          } else {
            tariffItems.push({
              name: 'MFN Base Tariff',
              rate: mfnRate,
              tag: 'mfn',
              description: `USMCA origin rules NOT met`,
              source: 'Rules (mfnRates)'
            });
            totalRate += mfnRate;

            const recip = getReciprocalRate(countryCode);
            tariffItems.push({
              name: 'Reciprocal Tariff (Non-compliant)',
              rate: recip,
              tag: 'ieepa',
              description: 'Applied because conditional FTA not satisfied',
              source: 'Rules (reciprocalRates)'
            });
            totalRate += recip;

            warnings.push(`‚ö†Ô∏è USMCA Certificate of Origin required for 0% rate. Check the compliant box if you have it.`);
          }
        }

        // CASE 2: Minimum rule (e.g., KR)
        else if (ftaInfo.type === 'minimum') {
          // base FTA rate assumed 0, apply minimum rule
          const calculatedRate = Math.max(0, mfnRate, Number(ftaInfo.minRate || 0));
          tariffItems.push({
            name: `${ftaInfo.fta} Minimum Rate`,
            rate: calculatedRate,
            tag: 'ieepa',
            description: `MAX(FTA 0%, MFN ${(mfnRate*100).toFixed(1)}%, Min ${(Number(ftaInfo.minRate||0)*100).toFixed(1)}%) = ${(calculatedRate*100).toFixed(1)}%`,
            source: 'Rules (ftaCountries)'
          });
          totalRate += calculatedRate;

          warnings.push(`‚ö†Ô∏è Minimum rate rule applies for this FTA per rule set.`);
        }

        // CASE 3: Standard FTA (0%)
        else {
          tariffItems.push({
            name: `${ftaInfo.fta} - Duty Free`,
            rate: 0,
            tag: 'fta',
            description: ftaInfo.description || '0% duty-free',
            source: ftaInfo.fta
          });
          exemptions.push(`‚úÖ ${ftaInfo.fta}: 0% duty-free treatment`);
        }
      } else {
        // NO FTA
        tariffItems.push({
          name: 'MFN Base Tariff (Column 1)',
          rate: mfnRate,
          tag: 'mfn',
          description: `From rules: ${(mfnRate * 100).toFixed(1)}%`,
          source: 'Rules (mfnRates)'
        });
        totalRate += mfnRate;

        const recip = getReciprocalRate(countryCode);
        tariffItems.push({
          name: 'Reciprocal Tariff',
          rate: recip,
          tag: 'ieepa',
          description: 'Country-specific rate from rules',
          source: 'Rules (reciprocalRates)'
        });
        totalRate += recip;

        // Optional hint based on HS rule flags
        if (countryCode === 'CN' && hsRule?.isAutoPartViaSection232) {
          warnings.push("‚ö†Ô∏è HS rule indicates potential auto-part measure triggers. Add detailed measures to rules.json if needed.");
        }
      }

      return {
        hsCode10,
        description,
        countryCode,
        ftaStatusText,
        tariffItems,
        totalRate,
        warnings,
        exemptions
      };
    }

    async function lookupTariff() {
      const origin = document.getElementById('origin').value;
      const hsCode = document.getElementById('hsCode').value.replace(/[.\s]/g, '');
      const usmcaCompliant = document.getElementById('usmcaCompliant')?.checked || false;

      if (!RULES) {
        alert("Rules not loaded yet. Click Update.");
        return;
      }

      if (!origin || !hsCode || hsCode.length < 6) {
        alert('Please select country and enter valid HS Code (min 6 digits).');
        return;
      }

      document.getElementById('loading').classList.add('show');
      document.getElementById('results').classList.remove('show');

      // short UX delay
      await new Promise(resolve => setTimeout(resolve, 450));

      const tariffData = calculateAccurateTariff(hsCode, origin, usmcaCompliant);
      displayResults(tariffData);
      recordHistory(tariffData);

      document.getElementById('loading').classList.remove('show');
      document.getElementById('results').classList.add('show');
    }

    function displayResults(data) {
      document.getElementById('displayHsCode').textContent = formatHsCode(data.hsCode10);
      document.getElementById('productCategory').textContent = data.description;
      document.getElementById('displayOrigin').textContent = getCountryLabel(data.countryCode);
      document.getElementById('ftaStatusResult').textContent = data.ftaStatusText;

      const totalBadge = document.getElementById('totalRate');
      totalBadge.textContent = (data.totalRate * 100).toFixed(1) + '%';
      if (data.totalRate === 0) totalBadge.classList.add('zero');
      else totalBadge.classList.remove('zero');

      let itemsHTML = '';
      data.tariffItems.forEach(item => {
        const tagHTML = item.tag ? `<span class="tag ${item.tag}">${String(item.tag).toUpperCase()}</span>` : '';
        const isFree = item.rate === 0 ? ' free' : '';
        const rateClass = item.rate === 0 ? ' zero' : '';
        itemsHTML += `
          <div class="tariff-item${isFree}">
            <div class="tariff-header">
              <div class="tariff-name">${escapeHtml(item.name)} ${tagHTML}</div>
              <div class="tariff-rate${rateClass}">${(item.rate * 100).toFixed(1)}%</div>
            </div>
            <div class="tariff-description">
              ${escapeHtml(item.description || '')}<br>
              <small style="color:#64748b; font-size:12px; font-weight:800;">Source: ${escapeHtml(item.source || '')}</small>
            </div>
          </div>
        `;
      });
      document.getElementById('tariffItems').innerHTML = itemsHTML;

      document.getElementById('exemptionContainer').innerHTML = data.exemptions.length ? `
        <div class="exemption-box">
          <div class="exemption-title">‚úÖ Exemptions Applied</div>
          <div style="font-size:14px; color:#047857; line-height:1.6; font-weight:800;">
            ${data.exemptions.map(escapeHtml).join('<br>')}
          </div>
        </div>` : '';

      document.getElementById('warningContainer').innerHTML = data.warnings.length ? `
        <div class="warning-box">
          <div class="warning-title">‚ö†Ô∏è Important Notes</div>
          <div style="font-size:14px; color:#78350f; line-height:1.6; font-weight:800;">
            ${data.warnings.map(escapeHtml).join('<br>')}
          </div>
        </div>` : '';
    }

    // =========================
    // HISTORY + CHART
    // =========================
    let tariffChart = null;

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveHistory(arr) {
      try { localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); } catch {}
    }

    function recordHistory(data) {
      const arr = loadHistory();
      arr.unshift({
        ts: new Date().toISOString(),
        hs: data.hsCode10,
        origin: data.countryCode,
        total: data.totalRate
      });
      const trimmed = arr.slice(0, HISTORY_MAX);
      saveHistory(trimmed);
      renderHistory(trimmed);
    }

    function renderHistory(arr) {
      const list = document.getElementById("timelineList");
      if (!list) return;

      if (!arr.length) {
        list.innerHTML = `<p class="muted">Search to view tariff history</p>`;
      } else {
        list.innerHTML = arr.map(x => {
          const d = new Date(x.ts);
          const when = isNaN(d.getTime()) ? x.ts : d.toLocaleString();
          return `
            <div style="background:#f7fafc; border:2px solid #e2e8f0; border-radius:12px; padding:12px; margin-bottom:10px;">
              <div style="font-weight:900; color:#1e293b; font-size:13px;">${escapeHtml(when)}</div>
              <div style="font-size:12px; color:#475569; font-weight:800; margin-top:6px;">
                ${escapeHtml(x.origin)} ‚Ä¢ ${escapeHtml(formatHsCode(String(x.hs)))} ‚Ä¢ <span style="font-weight:900;">${(Number(x.total)*100).toFixed(1)}%</span>
              </div>
            </div>
          `;
        }).join("");
      }

      renderChart(arr);
    }

    function renderChart(arr) {
      const canvas = document.getElementById("tariffChart");
      if (!canvas || !window.Chart) return;

      const labels = [...arr].reverse().map(x => {
        const d = new Date(x.ts);
        return isNaN(d.getTime()) ? "" : (d.getHours().toString().padStart(2,"0") + ":" + d.getMinutes().toString().padStart(2,"0"));
      });
      const data = [...arr].reverse().map(x => Number(x.total) * 100);

      if (tariffChart) tariffChart.destroy();

      tariffChart = new Chart(canvas, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Total Tariff (%)",
            data,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });
    }

    // =========================
    // INIT
    // =========================
    document.getElementById('hsCode').addEventListener('keypress', e => {
      if (e.key === 'Enter') lookupTariff();
    });

    window.addEventListener('load', async () => {
      // restore history immediately
      renderHistory(loadHistory());

      // load rules once on page load
      await refreshRules(false);

      // hourly refresh
      setInterval(() => refreshRules(false), AUTO_REFRESH_MS);

      // initial UI sync
      updateFtaStatus();
      displayNews();
    });
  </script>
</body>
</html>

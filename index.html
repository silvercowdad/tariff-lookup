<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ¤– US Tariff Lookup</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f1f5f9;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    h1 { margin-bottom: 10px; }
    .meta { font-size: 13px; color: #334155; margin-bottom: 15px; }
    .row { display: flex; gap: 10px; margin-bottom: 10px; }
    select, input {
      flex: 1;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      background: #1e3c72;
      color: white;
      font-weight: 700;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { opacity: 0.9; }
    .result {
      margin-top: 15px;
      padding: 12px;
      border-radius: 10px;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
    }
    .error {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }
    .ok {
      background: #dcfce7;
      border: 1px solid #bbf7d0;
      color: #065f46;
    }
    .small { font-size: 12px; color: #64748b; }
  </style>
</head>

<body>
  <div class="card">
    <h1>ğŸ¤– US Tariff Lookup</h1>

    <div class="meta" id="rulesMeta">Rules: not loaded yet</div>
    <div class="meta" id="apiStatusText">Status: -</div>

    <div class="row">
      <select id="origin">
        <option value="">Select Country</option>
        <option value="KR">South Korea (KR)</option>
        <option value="MX">Mexico (MX)</option>
        <option value="CA">Canada (CA)</option>
        <option value="CN">China (CN)</option>
        <option value="VN">Vietnam (VN)</option>
        <option value="JP">Japan (JP)</option>
      </select>

      <input id="hsCode" placeholder="HS Code (ex: 8507600010)" maxlength="10" />
    </div>

    <div class="row" style="align-items:center;">
      <label style="flex:1; display:flex; gap:10px; align-items:center;">
        <input type="checkbox" id="usmcaCompliant" />
        USMCA compliant?
      </label>
      <button style="flex:1;" onclick="refreshRules(true)">â¬‡ï¸ Update rules now</button>
    </div>

    <button onclick="lookupTariff()">ğŸ” Calculate</button>

    <div id="output" class="result" style="display:none;"></div>
    <div class="small" style="margin-top:10px;">
      â€¢ ìƒˆë¡œê³ ì¹¨í•˜ë©´ rules.jsonì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.<br>
      â€¢ 1ì‹œê°„ë§ˆë‹¤ ìë™ìœ¼ë¡œ rules ê°±ì‹ ë„ ì‹œë„í•©ë‹ˆë‹¤.
    </div>
  </div>

  <script>
  // =========================
  // CONFIG
  // =========================
  const RULES_URL = "./tariff-rules.json";
  const AUTO_REFRESH_MS = 60 * 60 * 1000; // 1 hour = 3,600,000ms (ë”ë¸”ì²´í¬ ì™„ë£Œ)

  function urlNoCache(url) {
    const sep = url.includes("?") ? "&" : "?";
    return url + sep + "v=" + Date.now();
  }

  // =========================
  // RULES (fetched)
  // =========================
  let RULES = null;

  // fallback (fetch ì‹¤íŒ¨ ì‹œ ìµœì†Œ ë™ì‘)
  const FALLBACK_RULES = {
    meta: { rulesVersion: "fallback", updatedAt: null, statusText: "Fallback rules (fetch failed)" },
    ftaCountries: {},
    countries: {},
    hsCodeRules: {},
    mfnRates: {},
    reciprocalRates: { DEFAULT: 0.10 },
    productDescriptions: {}
  };

  async function refreshRules(showAlertOnFailure = false) {
    const statusEl = document.getElementById("apiStatusText");
    const metaEl = document.getElementById("rulesMeta");

    if (statusEl) statusEl.textContent = "Updating rules from internet...";
    if (metaEl) {
      metaEl.classList.remove("error");
      metaEl.textContent = "Rules: updating...";
    }

    try {
      const res = await fetch(urlNoCache(RULES_URL), { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();

      // ìµœì†Œ ìŠ¤í‚¤ë§ˆ ì²´í¬
      if (!json || !json.ftaCountries || !json.mfnRates || !json.reciprocalRates) {
        throw new Error("Invalid rules schema (need ftaCountries/mfnRates/reciprocalRates)");
      }

      RULES = json;

      const version = RULES.meta?.rulesVersion ?? "(no version)";
      const updatedAt = RULES.meta?.updatedAt ?? "(no updatedAt)";
      const statusText = RULES.meta?.statusText ?? "Rules loaded";

      if (statusEl) statusEl.textContent = statusText;
      if (metaEl) metaEl.textContent = `Rules loaded âœ“ version=${version} â€¢ updatedAt=${updatedAt}`;

      // ë£° ê°±ì‹  í›„ UI ìƒíƒœ ê°±ì‹ 
      updateFtaStatus();
      displayNews();

      return true;
    } catch (err) {
      RULES = FALLBACK_RULES;
      if (statusEl) statusEl.textContent = "Rule fetch failed (using fallback)";
      if (metaEl) {
        metaEl.textContent = "Rules: fetch failed âœ— using fallback rules";
        metaEl.classList.add("error");
      }
      if (showAlertOnFailure) alert("Rules update failed: " + err.message);
      return false;
    }
  }

  // =========================
  // DATA ACCESSORS (from RULES)
  // =========================
  function getFTACountry(code) {
    return RULES?.ftaCountries?.[code] || null;
  }

  function getCountryLabel(code) {
    return RULES?.countries?.[code] || code;
  }

  function getHsRule(hsCode10) {
    return RULES?.hsCodeRules?.[hsCode10] || RULES?.hsCodeRules?.[hsCode10.substring(0,10)] || null;
  }

  function getMFNRate(hsCode) {
    const k6 = hsCode.substring(0, 6);
    const k4 = hsCode.substring(0, 4);
    const r6 = RULES?.mfnRates?.[k6];
    if (typeof r6 === "number") return r6;
    const r4 = RULES?.mfnRates?.[k4];
    if (typeof r4 === "number") return r4;
    return 0.10;
  }

  function getReciprocalRate(countryCode) {
    const r = RULES?.reciprocalRates?.[countryCode];
    if (typeof r === "number") return r;
    const d = RULES?.reciprocalRates?.DEFAULT;
    if (typeof d === "number") return d;
    return 0.10;
  }

  function getProductDescription(hsCode) {
    const k4 = hsCode.substring(0, 4);
    return RULES?.productDescriptions?.[k4] || `HS Code ${hsCode}`;
  }

  // =========================
  // ORIGINAL LOGIC (adapted)
  // =========================
  let tariffChart = null; // (ì›ë˜ ì½”ë“œì—ì„œ ì“°ë©´ ìœ ì§€)

  function updateFtaStatus() {
    const origin = document.getElementById('origin').value;
    const ftaStatus = document.getElementById('ftaStatus');
    const usmcaCheckbox = document.getElementById('usmcaCheckbox');

    if (!origin) {
      ftaStatus.textContent = '';
      usmcaCheckbox.style.display = 'none';
      return;
    }

    const ftaInfo = getFTACountry(origin);

    if (ftaInfo) {
      if (ftaInfo.type === 'conditional') {
        ftaStatus.textContent = `âœ“ ${ftaInfo.fta} - ${ftaInfo.description}`;
        ftaStatus.style.color = '#059669';
        usmcaCheckbox.style.display = 'block';
      } else if (ftaInfo.type === 'minimum') {
        ftaStatus.textContent = `âš ï¸ ${ftaInfo.fta} - ${ftaInfo.description}`;
        ftaStatus.style.color = '#d97706';
        usmcaCheckbox.style.display = 'none';
      } else {
        ftaStatus.textContent = `âœ“ ${ftaInfo.fta} - ${ftaInfo.description}`;
        ftaStatus.style.color = '#059669';
        usmcaCheckbox.style.display = 'none';
      }
    } else {
      ftaStatus.textContent = 'âŒ No FTA - Full tariffs apply';
      ftaStatus.style.color = '#dc2626';
      usmcaCheckbox.style.display = 'none';
    }
  }

  async function lookupTariff() {
    const origin = document.getElementById('origin').value;
    const hsCode = document.getElementById('hsCode').value.replace(/[.\s]/g, '');
    const usmcaCompliant = document.getElementById('usmcaCompliant')?.checked || false;

    if (!origin || !hsCode || hsCode.length < 6) {
      alert('Please select country and enter valid HS Code (min 6 digits).');
      return;
    }

    document.getElementById('loading').classList.add('show');
    document.getElementById('results').classList.remove('show');

    await new Promise(resolve => setTimeout(resolve, 600));

    const tariffData = calculateAccurateTariff(hsCode, origin, usmcaCompliant);
    displayResults(tariffData);
    displayNews();

    document.getElementById('loading').classList.remove('show');
    document.getElementById('results').classList.add('show');
  }

  function calculateAccurateTariff(hsCode, countryCode, usmcaCompliant = false) {
    const hsCode10 = hsCode.padEnd(10, '0');
    const hsRule = getHsRule(hsCode10);
    const ftaInfo = getFTACountry(countryCode);

    let tariffItems = [];
    let totalRate = 0;
    let warnings = [];
    let exemptions = [];
    let ftaStatusText = 'No FTA';

    const description = hsRule?.description || getProductDescription(hsCode);
    const mfnRate = getMFNRate(hsCode);

    if (ftaInfo) {
      ftaStatusText = ftaInfo.fta;

      // CASE 1: Conditional (USMCA)
      if (ftaInfo.type === 'conditional') {
        if (usmcaCompliant) {
          tariffItems.push({
            name: `${ftaInfo.fta} - Duty Free`,
            rate: 0,
            tag: 'fta',
            description: 'Certificate of Origin: Rules of Origin met',
            source: ftaInfo.fta
          });
          exemptions.push(`âœ… ${ftaInfo.fta}: Waived with valid Certificate of Origin`);
        } else {
          tariffItems.push({
            name: 'MFN Base Tariff',
            rate: mfnRate,
            tag: 'mfn',
            description: `Origin rules NOT met`,
            source: 'Rules (mfnRates)'
          });
          totalRate += mfnRate;

          const recip = getReciprocalRate(countryCode);
          tariffItems.push({
            name: 'Reciprocal Tariff (Non-compliant)',
            rate: recip,
            tag: 'ieepa',
            description: 'Applied because conditional FTA not satisfied',
            source: 'Rules (reciprocalRates)'
          });
          totalRate += recip;

          warnings.push(`âš ï¸ Certificate of Origin required for 0% rate. Check the compliant box if you have it.`);
        }
      }

      // CASE 2: Minimum (KORUS-like)
      else if (ftaInfo.type === 'minimum') {
        const baseFtaRate = 0;
        const calculatedRate = Math.max(baseFtaRate, mfnRate, ftaInfo.minRate);

        tariffItems.push({
          name: `${ftaInfo.fta} Minimum Rate`,
          rate: calculatedRate,
          tag: 'ieepa',
          description: `MAX(FTA 0%, MFN ${(mfnRate*100).toFixed(1)}%, Min ${(ftaInfo.minRate*100).toFixed(1)}%) = ${(calculatedRate*100).toFixed(1)}%`,
          source: 'Rules (ftaCountries)'
        });
        totalRate += calculatedRate;

        warnings.push(`âš ï¸ Minimum rate rule applies for this FTA per rule set.`);
      }

      // CASE 3: Standard (0%)
      else {
        tariffItems.push({
          name: `${ftaInfo.fta} - Duty Free`,
          rate: 0,
          tag: 'fta',
          description: ftaInfo.description,
          source: ftaInfo.fta
        });
        exemptions.push(`âœ… ${ftaInfo.fta}: 0% duty-free treatment`);
      }
    } else {
      // NO FTA
      tariffItems.push({
        name: 'MFN Base Tariff (Column 1)',
        rate: mfnRate,
        tag: 'mfn',
        description: `From rules: ${(mfnRate * 100).toFixed(1)}%`,
        source: 'Rules (mfnRates)'
      });
      totalRate += mfnRate;

      const recip = getReciprocalRate(countryCode);
      tariffItems.push({
        name: 'Reciprocal Tariff',
        rate: recip,
        tag: 'ieepa',
        description: 'Country-specific rate from rules',
        source: 'Rules (reciprocalRates)'
      });
      totalRate += recip;

      // hsRule ê¸°ë°˜ ì¶”ê°€ ê²½ê³ (ì›í•˜ë©´ rules.jsonì— ë” í™•ì¥ ê°€ëŠ¥)
      if (countryCode === 'CN' && hsRule?.isAutoPartViaSection232) {
        warnings.push("âš ï¸ This HS rule indicates auto-part classification may trigger additional measures. Add detailed measures in rules.json if needed.");
      }
    }

    return { hsCode10, description, countryCode, ftaStatusText, tariffItems, totalRate, warnings, exemptions };
  }

  function displayResults(data) {
    document.getElementById('displayHsCode').textContent = formatHsCode(data.hsCode10);
    document.getElementById('productCategory').textContent = data.description;
    document.getElementById('displayOrigin').textContent = getCountryLabel(data.countryCode);
    document.getElementById('ftaStatusResult').textContent = data.ftaStatusText;

    const totalBadge = document.getElementById('totalRate');
    totalBadge.textContent = (data.totalRate * 100).toFixed(1) + '%';
    if (data.totalRate === 0) totalBadge.classList.add('zero');
    else totalBadge.classList.remove('zero');

    let itemsHTML = '';
    data.tariffItems.forEach(item => {
      const tagHTML = item.tag ? `<span class="tag ${item.tag}">${item.tag.toUpperCase()}</span>` : '';
      const isFree = item.rate === 0 ? ' free' : '';
      const rateClass = item.rate === 0 ? ' zero' : '';
      itemsHTML += `
        <div class="tariff-item${isFree}">
          <div class="tariff-header">
            <div class="tariff-name">${item.name} ${tagHTML}</div>
            <div class="tariff-rate${rateClass}">${(item.rate * 100).toFixed(1)}%</div>
          </div>
          <div class="tariff-description">
            ${item.description}<br>
            <small style="color: #64748b; font-size: 12px;">Source: ${item.source}</small>
          </div>
        </div>
      `;
    });
    document.getElementById('tariffItems').innerHTML = itemsHTML;

    document.getElementById('exemptionContainer').innerHTML = data.exemptions.length ? `
      <div class="exemption-box">
        <div class="exemption-title">âœ… Exemptions Applied</div>
        <div style="font-size: 14px; color: #047857; line-height: 1.6;">
          ${data.exemptions.join('<br>')}
        </div>
      </div>` : '';

    document.getElementById('warningContainer').innerHTML = data.warnings.length ? `
      <div class="warning-box">
        <div class="warning-title">âš ï¸ Important Notes</div>
        <div style="font-size: 14px; color: #78350f; line-height: 1.6;">
          ${data.warnings.join('<br>')}
        </div>
      </div>` : '';
  }

  function displayNews() {
    const el = document.getElementById('newsContent');
    if (!el) return;

    const version = RULES?.meta?.rulesVersion ?? "(no version)";
    const updatedAt = RULES?.meta?.updatedAt ?? "(no updatedAt)";
    const items = RULES?.news || [
      { date: updatedAt, headline: "Rules loaded", body: `Using version ${version}` }
    ];

    el.innerHTML = items.map((n, i) => `
      <div class="news-item ${i === 0 ? 'urgent' : ''}">
        <div class="news-date">${n.date || ''}</div>
        <div class="news-headline">${n.headline || ''}</div>
        <div style="font-size: 13px; color: #475569; line-height: 1.5; margin-top: 5px;">
          ${n.body || ''}
        </div>
      </div>
    `).join('');
  }

  function formatHsCode(code) {
    if (code.length === 10) return code.substring(0, 4) + '.' + code.substring(4, 6) + '.' + code.substring(6, 10);
    if (code.length >= 6) return code.substring(0, 4) + '.' + code.substring(4, 6);
    return code;
  }

  // =========================
  // INIT
  // =========================
  document.addEventListener('DOMContentLoaded', async () => {
    // (ì„ íƒ) ìƒë‹¨ ìƒíƒœ í…ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ë ¤ë©´, HTMLì—ì„œ ì•„ë˜ idë“¤ì„ ë„£ì–´ì•¼ í•¨:
    // - apiStatusText (ìƒë‹¨ ìƒíƒœ ë¬¸êµ¬)
    // - rulesMeta (ë²„ì „/ì—…ë°ì´íŠ¸ì‹œê° í‘œì‹œ)
    // ì›ë˜ UIì— ì—†ìœ¼ë©´ ì—†ì–´ë„ ë™ì‘ì€ í•¨.

    await refreshRules(false);

    // ë¡œë“œ ì‹œ 1íšŒ fetch + 1ì‹œê°„ë§ˆë‹¤ ê°±ì‹ 
    setInterval(() => refreshRules(false), AUTO_REFRESH_MS);

    // Enter í‚¤ë¡œ ì¡°íšŒ
    const hs = document.getElementById('hsCode');
    if (hs) hs.addEventListener('keypress', e => { if (e.key === 'Enter') lookupTariff(); });

    displayNews();
    updateFtaStatus();
  });

  // ì—…ë°ì´íŠ¸ ë²„íŠ¼ì„ ì›ë˜ UIì— ë‹¬ê³  ì‹¶ìœ¼ë©´,
  // ë²„íŠ¼ onclick="refreshRules(true)" ë¡œ ì—°ê²°í•˜ë©´ ë¨.
</script>

</body>
</html>



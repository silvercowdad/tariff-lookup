<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ü§ñ US Tariff Lookup - FTA-Aware Automation</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 380px 1fr 350px;
      gap: 20px;
    }
    @media (max-width: 1400px) {
      .container { grid-template-columns: 1fr 350px; }
      .history-sidebar { display: none !important; }
    }
    @media (max-width: 1024px) {
      .container { grid-template-columns: 1fr; }
      .news-sidebar { display: none !important; }
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 { color:#1a202c; font-size:32px; margin-bottom:10px; }
    .subtitle { color:#718096; font-size:14px; margin-bottom:14px; }
    .fta-badge {
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px; background:linear-gradient(135deg,#10b981 0%,#059669 100%);
      color:#fff; border-radius:20px; font-size:11px; font-weight:800; margin-left:10px;
    }

    .api-status {
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 14px; background:#d1fae5; border-radius:14px;
      font-size:12px; font-weight:800; color:#065f46; margin-bottom:14px;
      border:2px solid #a7f3d0;
    }
    .api-left { display:flex; align-items:center; gap:10px; min-width:0; }
    .api-status .dot {
      width:8px; height:8px; background:#10b981; border-radius:50%;
      animation:pulse 2s infinite; flex:0 0 auto;
    }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.5;} }
    .api-text { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta-line { font-size:11px; opacity:0.9; margin-top:2px; font-weight:800; }
    .api-actions { display:flex; gap:10px; flex:0 0 auto; }
    .mini-btn {
      padding:8px 10px; border:none; border-radius:10px;
      background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      color:#fff; font-size:12px; font-weight:900; cursor:pointer;
      box-shadow:0 4px 12px rgba(30,60,114,0.25);
    }
    .mini-btn:hover { transform: translateY(-1px); }

    .search-section { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:12px; }
    label { display:block; margin-bottom:8px; color:#2d3748; font-weight:900; font-size:14px; }
    input, select {
      width:100%; padding:14px 16px; border:2px solid #e2e8f0; border-radius:10px;
      font-size:16px; background:#f7fafc; transition: all 0.2s;
    }
    input:focus, select:focus {
      outline:none; border-color:#1e3c72; background:#fff;
      box-shadow:0 0 0 3px rgba(30,60,114,0.1);
    }

    .hs-code-input { font-family:'Courier New', monospace; font-size:18px; font-weight:900; letter-spacing:1px; }
    .hs-helper { font-size:11px; color:#64748b; margin-top:6px; font-weight:800; }

    #ftaStatus { margin-top:8px; font-size:12px; font-weight:900; }

    .checkbox-group {
      margin-top:12px; padding:14px; background:#f0f9ff; border-radius:10px; border:2px solid #bae6fd;
    }
    .checkbox-group label { display:flex; align-items:center; gap:10px; cursor:pointer; font-size:14px; margin-bottom:0; font-weight:900; color:#0f172a; }
    input[type="checkbox"] { width:20px; height:20px; cursor:pointer; }

    .main-btn {
      width:100%; padding:16px; background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      color:#fff; border:none; border-radius:10px; font-size:17px; font-weight:900; cursor:pointer;
      transition:all 0.2s; box-shadow:0 4px 15px rgba(30,60,114,0.3); margin-top:12px;
    }
    .main-btn:hover { transform: translateY(-2px); box-shadow:0 6px 25px rgba(30,60,114,0.4); }

    .loading { display:none; text-align:center; padding:24px; }
    .loading.show { display:block; }
    .spinner {
      border:4px solid #f3f3f3; border-top:4px solid #1e3c72; border-radius:50%;
      width:50px; height:50px; animation:spin 1s linear infinite; margin:0 auto;
    }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

    .results-card { display:none; }
    .results-card.show { display:block; animation: slideIn 0.35s; }
    @keyframes slideIn { from{opacity:0; transform:translateY(12px);} to{opacity:1; transform:translateY(0);} }

    .results-header {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:18px; padding-bottom:16px; border-bottom:2px solid #e2e8f0;
    }
    .total-badge {
      padding:12px 24px; background:linear-gradient(135deg,#f56565 0%,#e53e3e 100%);
      color:#fff; border-radius:25px; font-size:24px; font-weight:900;
      box-shadow:0 4px 15px rgba(245,101,101,0.3);
    }
    .total-badge.zero { background:linear-gradient(135deg,#10b981 0%,#059669 100%); }

    .info-box {
      background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);
      border-left:4px solid #0284c7; padding:18px; border-radius:8px; margin-bottom:18px;
    }
    .info-row { display:flex; justify-content:space-between; padding:7px 0; font-size:15px; }
    .info-label { color:#0369a1; font-weight:900; }
    .info-value { color:#075985; font-weight:900; }

    .tariff-item {
      background:#f7fafc; border:2px solid #e2e8f0; border-radius:12px; padding:18px; margin-bottom:12px;
      transition: all 0.2s;
    }
    .tariff-item:hover { border-color:#1e3c72; box-shadow:0 4px 15px rgba(30,60,114,0.1); }
    .tariff-item.free { border-color:#10b981; background:#f0fdf4; }

    .tariff-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .tariff-name { font-size:16px; font-weight:900; color:#2d3748; }
    .tariff-rate { font-size:28px; font-weight:900; color:#e53e3e; }
    .tariff-rate.zero { color:#10b981; }
    .tariff-description { font-size:14px; color:#4a5568; line-height:1.6; margin-top:6px; font-weight:700; }

    .tag {
      display:inline-block; padding:4px 12px; border-radius:12px; font-size:11px; font-weight:900;
      text-transform:uppercase; margin-left:8px;
    }
    .tag.fta { background:#d1fae5; color:#065f46; }
    .tag.mfn { background:#dbeafe; color:#1e40af; }
    .tag.ieepa { background:#e9d5ff; color:#6b21a8; }
    .tag.section232 { background:#fee2e2; color:#991b1b; }
    .tag.section301 { background:#fef3c7; color:#92400e; }

    .warning-box { background:#fef3c7; border:2px solid #fbbf24; border-radius:12px; padding:16px; margin-top:14px; }
    .warning-title { font-weight:900; color:#92400e; margin-bottom:8px; font-size:15px; }

    .exemption-box { background:#d1fae5; border:2px solid #10b981; border-radius:12px; padding:16px; margin-top:14px; }
    .exemption-title { font-weight:900; color:#065f46; margin-bottom:8px; font-size:15px; }

    .history-card, .news-card {
      background:white; border-radius:16px; padding:22px; box-shadow:0 10px 40px rgba(0,0,0,0.2);
      position:sticky; top:20px; max-height:calc(100vh - 40px); overflow-y:auto;
    }
    .chart-container { position:relative; height:280px; margin-bottom:14px; }

    .news-item { background:#f7fafc; border-left:4px solid #3b82f6; padding:14px; margin-bottom:12px; border-radius:8px; }
    .news-item.urgent { border-left-color:#ef4444; }
    .news-headline { font-size:14px; font-weight:900; color:#1e293b; margin-bottom:4px; }
    .news-date { font-size:11px; color:#64748b; font-weight:900; margin-bottom:4px; }

    .muted { color:#94a3b8; font-size:13px; text-align:center; padding:22px 10px; font-weight:900; }

    footer {
      text-align:center; color:white; margin-top:30px; opacity:0.9; font-size:13px; grid-column:1 / -1; font-weight:900;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- History Sidebar -->
    <div class="history-sidebar">
      <div class="history-card">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:14px; padding-bottom:12px; border-bottom:2px solid #e2e8f0;">
          <span style="font-size:24px;">üìà</span>
          <span style="font-size:18px; font-weight:900; color:#1a202c;">Tariff History</span>
        </div>
        <div class="chart-container"><canvas id="tariffChart"></canvas></div>
        <div id="timelineList"><p class="muted">Search to view tariff history</p></div>
      </div>
    </div>

    <!-- Main Content -->
    <div style="display:flex; flex-direction:column; gap:20px;">
      <div class="card">
        <h1>ü§ñ US Tariff Lookup</h1>
        <p class="subtitle">
          Extensible Rules Engine ‚Ä¢ JSON-driven measures/waivers
          <span class="fta-badge">‚úì LIVE RULES</span>
        </p>

        <div class="api-status">
          <div class="api-left">
            <span class="dot"></span>
            <div style="min-width:0;">
              <div class="api-text" id="apiStatusText">Loading rules...</div>
              <div class="meta-line" id="rulesMeta">Rules: updating...</div>
            </div>
          </div>
          <div class="api-actions">
            <button class="mini-btn" onclick="refreshRules(true)">‚¨áÔ∏è Update</button>
          </div>
        </div>

        <div class="search-section">
          <div>
            <label for="origin">üåç Country of Origin</label>
            <select id="origin" onchange="updateFtaStatus()">
              <option value="">Select Country</option>

              <optgroup label="üü¢ FTA (Special)">
                <option value="KR">üá∞üá∑ South Korea (KORUS - Minimum)</option>
                <option value="MX">üá≤üáΩ Mexico (USMCA - Conditional)</option>
                <option value="CA">üá®üá¶ Canada (USMCA - Conditional)</option>
              </optgroup>

              <optgroup label="üî¥ No FTA (Examples)">
                <option value="CN">üá®üá≥ China</option>
                <option value="VN">üáªüá≥ Vietnam</option>
                <option value="JP">üáØüáµ Japan</option>
                <option value="TW">üáπüáº Taiwan</option>
                <option value="MY">üá≤üáæ Malaysia</option>
                <option value="IN">üáÆüá≥ India</option>
                <option value="TH">üáπüá≠ Thailand</option>
              </optgroup>
            </select>

            <div id="ftaStatus"></div>
          </div>

          <div>
            <label for="hsPreset">üì¶ HS Code (Preset)</label>
            <select id="hsPreset" onchange="applyHsPreset()">
              <option value="">Select HS preset</option>
              <option value="8507600010">8507.60.0010 (Auto)</option>
              <option value="8507600020">8507.60.0020 (ESS / MPB)</option>
            </select>

            <div style="margin-top:10px;">
              <label for="hsCode" style="margin-bottom:6px;">Or enter HS Code (6-10 digits)</label>
              <input type="text" id="hsCode" class="hs-code-input" placeholder="8507600010" maxlength="10" />
              <div class="hs-helper">Dots/spaces OK (e.g., 8507.60.0010)</div>
            </div>
          </div>
        </div>

        <div id="usmcaCheckbox" style="display:none;">
          <div class="checkbox-group">
            <label>
              <input type="checkbox" id="usmcaCompliant" />
              <span>‚úÖ USMCA Certificate of Origin available (Rules of Origin met)</span>
            </label>
            <div style="font-size:11px; color:#64748b; margin-top:8px; margin-left:30px; font-weight:900;">
              If unchecked: MFN + measures apply
            </div>
          </div>
        </div>

        <button class="main-btn" onclick="lookupTariff()">üîé Calculate Accurate Tariff</button>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p style="margin-top:14px; color:#4a5568; font-weight:900;">
            Processing rules...<br/>
            <span style="font-size:12px; color:#718096; font-weight:900;">
              Load on refresh + auto refresh every hour
            </span>
          </p>
        </div>
      </div>

      <div class="card results-card" id="results">
        <div class="results-header">
          <div style="font-size:22px; color:#1a202c; font-weight:900;">Tariff Calculation</div>
          <div class="total-badge" id="totalRate">0%</div>
        </div>

        <div class="info-box">
          <div class="info-row"><span class="info-label">HS Code</span><span class="info-value" id="displayHsCode">-</span></div>
          <div class="info-row"><span class="info-label">Product</span><span class="info-value" id="productCategory">-</span></div>
          <div class="info-row"><span class="info-label">Origin</span><span class="info-value" id="displayOrigin">-</span></div>
          <div class="info-row"><span class="info-label">FTA Status</span><span class="info-value" id="ftaStatusResult">-</span></div>
        </div>

        <div style="margin-top:18px;">
          <div style="font-size:18px; font-weight:900; color:#1a202c; margin-bottom:12px;">üìä Tariff Breakdown</div>
          <div id="tariffItems"></div>
        </div>

        <div id="exemptionContainer"></div>
        <div id="warningContainer"></div>
      </div>
    </div>

    <!-- News Sidebar -->
    <div class="news-sidebar">
      <div class="news-card">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:14px; padding-bottom:12px; border-bottom:2px solid #e2e8f0;">
          <span style="font-size:24px;">üì∞</span>
          <span style="font-size:18px; font-weight:900; color:#1a202c;">Rule Updates</span>
        </div>
        <div id="newsContent"></div>
      </div>
    </div>

    <footer>
      <p>‚ö° JSON-driven measures/waivers ‚Ä¢ refresh or Update button ‚Ä¢ hourly auto refresh</p>
      <p style="margin-top:6px; font-size:11px;">Admin updates KV ‚Üí users click Update to fetch /rules</p>
    </footer>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const RULES_URL = "https://tariff-rules-live.sys1107.workers.dev/rules";
    const AUTO_REFRESH_MS = 60 * 60 * 1000; // 1 hour = 3,600,000ms (ÎçîÎ∏îÏ≤¥ÌÅ¨ ÏôÑÎ£å)
    const HISTORY_KEY = "tariff_lookup_history_v1";
    const HISTORY_MAX = 12;

    function urlNoCache(url) {
      const sep = url.includes("?") ? "&" : "?";
      return url + sep + "v=" + Date.now();
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function normalizeHs(input) {
      return String(input || "").replace(/[^\d]/g, ""); // keep digits only
    }

    function hs10(hs) {
      const x = normalizeHs(hs);
      return x.padEnd(10, "0").slice(0, 10);
    }

    // =========================
    // RULES
    // =========================
    let RULES = null;

    const FALLBACK_RULES = {
      meta: { rulesVersion: "fallback", updatedAt: null, statusText: "Fallback rules (fetch failed)" },
      ftaCountries: {},
      countries: {},
      hsCodeRules: {},
      mfnRates: {},
      reciprocalRates: { DEFAULT: 0.10 },
      productDescriptions: {},
      measures: [],
      waivers: [],
      news: []
    };

    async function refreshRules(showAlertOnFailure = false) {
      const statusEl = document.getElementById("apiStatusText");
      const metaEl = document.getElementById("rulesMeta");

      if (statusEl) statusEl.textContent = "Updating rules from internet...";
      if (metaEl) metaEl.textContent = "Rules: updating...";

      try {
        const res = await fetch(urlNoCache(RULES_URL), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();

        // minimum schema check
        if (!json || !json.ftaCountries || !json.mfnRates || !json.reciprocalRates || !Array.isArray(json.measures)) {
          throw new Error("Invalid rules schema (need ftaCountries/mfnRates/reciprocalRates/measures[])");
        }

        RULES = json;

        const version = RULES.meta?.rulesVersion ?? "(no version)";
        const updatedAt = RULES.meta?.updatedAt ?? "(no updatedAt)";
        const statusText = RULES.meta?.statusText ?? "Rules loaded ‚úì";

        if (statusEl) statusEl.textContent = statusText;
        if (metaEl) metaEl.textContent = `Rules loaded ‚úì version=${version} ‚Ä¢ updatedAt=${updatedAt}`;

        updateFtaStatus();
        displayNews();
        return true;
      } catch (err) {
        RULES = FALLBACK_RULES;
        if (statusEl) statusEl.textContent = "Rule fetch failed (fallback)";
        if (metaEl) metaEl.textContent = "Rules: fetch failed ‚úó using fallback rules";
        if (showAlertOnFailure) alert("Rules update failed: " + err.message);
        return false;
      }
    }

    // =========================
    // ACCESSORS
    // =========================
    function getCountryLabel(code) {
      return RULES?.countries?.[code] || code;
    }

    function getFTACountry(code) {
      return RULES?.ftaCountries?.[code] || null;
    }

    function getHsRule(hs10code) {
      return RULES?.hsCodeRules?.[hs10code] || null;
    }

    function getHsFlags(hs10code) {
      return getHsRule(hs10code)?.flags || {};
    }

    function getMFNRate(hs) {
      const x = normalizeHs(hs);
      const k6 = x.substring(0, 6);
      const k4 = x.substring(0, 4);
      const r6 = RULES?.mfnRates?.[k6];
      if (typeof r6 === "number") return r6;
      const r4 = RULES?.mfnRates?.[k4];
      if (typeof r4 === "number") return r4;
      return 0.10;
    }

    function getReciprocalRate(countryCode) {
      const r = RULES?.reciprocalRates?.[countryCode];
      if (typeof r === "number") return r;
      const d = RULES?.reciprocalRates?.DEFAULT;
      if (typeof d === "number") return d;
      return 0.10;
    }

    function getProductDescription(hs) {
      const x = normalizeHs(hs);
      const code10 = hs10(x);
      const rule = getHsRule(code10);
      if (rule?.description) return rule.description;

      const k4 = x.substring(0, 4);
      return RULES?.productDescriptions?.[k4] || `HS Code ${x}`;
    }

    function formatHsCode(code10) {
      const c = String(code10 || "");
      if (c.length === 10) return c.substring(0,4) + "." + c.substring(4,6) + "." + c.substring(6,10);
      return c;
    }

    // =========================
    // HS PRESET
    // =========================
    function applyHsPreset() {
      const preset = document.getElementById("hsPreset").value;
      if (preset) document.getElementById("hsCode").value = preset;
    }

    // =========================
    // UI
    // =========================
    function updateFtaStatus() {
      const origin = document.getElementById('origin').value;
      const ftaStatus = document.getElementById('ftaStatus');
      const usmcaBox = document.getElementById('usmcaCheckbox');

      if (!origin) {
        ftaStatus.textContent = '';
        ftaStatus.style.color = '#059669';
        usmcaBox.style.display = 'none';
        return;
      }

      const ftaInfo = getFTACountry(origin);
      if (ftaInfo) {
        if (ftaInfo.type === 'conditional') {
          ftaStatus.textContent = `‚úì ${ftaInfo.fta} - ${ftaInfo.description}`;
          ftaStatus.style.color = '#059669';
          usmcaBox.style.display = 'block';
        } else if (ftaInfo.type === 'minimum') {
          ftaStatus.textContent = `‚ö†Ô∏è ${ftaInfo.fta} - ${ftaInfo.description}`;
          ftaStatus.style.color = '#d97706';
          usmcaBox.style.display = 'none';
        } else {
          ftaStatus.textContent = `‚úì ${ftaInfo.fta} - ${ftaInfo.description}`;
          ftaStatus.style.color = '#059669';
          usmcaBox.style.display = 'none';
        }
      } else {
        ftaStatus.textContent = '‚ùå No FTA - measures apply';
        ftaStatus.style.color = '#dc2626';
        usmcaBox.style.display = 'none';
      }
    }

    function displayNews() {
      const el = document.getElementById('newsContent');
      if (!el) return;

      const version = RULES?.meta?.rulesVersion ?? "(no version)";
      const updatedAt = RULES?.meta?.updatedAt ?? "(no updatedAt)";
      const items = (RULES?.news && Array.isArray(RULES.news) && RULES.news.length)
        ? RULES.news
        : [{ date: updatedAt, headline: "Rules loaded", body: `Using version ${version}` }];

      el.innerHTML = items.map((n, i) => `
        <div class="news-item ${i === 0 ? 'urgent' : ''}">
          <div class="news-date">${escapeHtml(n.date || '')}</div>
          <div class="news-headline">${escapeHtml(n.headline || '')}</div>
          <div style="font-size:13px; color:#475569; line-height:1.5; margin-top:5px; font-weight:800;">
            ${escapeHtml(n.body || '')}
          </div>
        </div>
      `).join('');
    }

    // =========================
    // EXT ENGINE: measures + waivers
    // =========================
    function appliesWhen(measure, ctx) {
      const w = measure.appliesWhen || {};
      if (w.countries && Array.isArray(w.countries) && !w.countries.includes(ctx.country)) return false;
      if (w.noFta === true && ctx.hasFta === true) return false;
      if (w.flagsAll && Array.isArray(w.flagsAll)) {
        for (const f of w.flagsAll) {
          if (!ctx.flags[f]) return false;
        }
      }
      if (w.flagsAny && Array.isArray(w.flagsAny)) {
        let ok = false;
        for (const f of w.flagsAny) if (ctx.flags[f]) ok = true;
        if (!ok) return false;
      }
      return true;
    }

    function measureRate(measure, ctx) {
      if (typeof measure.rate === "number") return measure.rate;
      if (measure.rateSource === "mfn") return ctx.mfnRate;
      if (measure.rateSource === "reciprocal") return ctx.recipRate;
      return 0;
    }

    function calculateTariff(hsInput, country, usmcaCompliant) {
      const code10 = hs10(hsInput);
      const flags = getHsFlags(code10);
      const description = getProductDescription(code10);

      const ftaInfo = getFTACountry(country);
      const hasFta = !!ftaInfo;
      const recipRate = getReciprocalRate(country);
      const mfnRate = getMFNRate(code10);

      let tariffItems = [];
      let warnings = [];
      let exemptions = [];
      let totalRate = 0;
      let ftaStatusText = hasFta ? ftaInfo.fta : "No FTA";

      // ---- Step 1) Base treatment (FTA / MFN)
      // USMCA compliant: if waiveAllWhenCompliant=true -> all measures waived
      let waiveAll = false;

      if (ftaInfo && ftaInfo.type === "conditional") {
        if (usmcaCompliant) {
          tariffItems.push({
            name: `${ftaInfo.fta} - Duty Free`,
            rate: 0,
            tag: "fta",
            description: "Certificate of Origin: Rules of Origin met",
            source: ftaInfo.fta
          });
          if (ftaInfo.waiveAllWhenCompliant) {
            waiveAll = true;
            exemptions.push(`‚úÖ ${ftaInfo.fta}: All measures waived (compliant)`);
          } else {
            exemptions.push(`‚úÖ ${ftaInfo.fta}: Base duty-free (compliant)`);
          }
        } else {
          // Not compliant -> treat like no-FTA base + measures
          warnings.push("‚ö†Ô∏è USMCA Certificate of Origin required for 0% rate (compliant).");
        }
      } else if (ftaInfo && ftaInfo.type === "minimum") {
        const minRate = Number(ftaInfo.minRate || 0);
        const base = Math.max(0, mfnRate, minRate);
        tariffItems.push({
          name: `${ftaInfo.fta} Minimum Rate`,
          rate: base,
          tag: "ieepa",
          description: `MAX(FTA 0%, MFN ${(mfnRate*100).toFixed(1)}%, Min ${(minRate*100).toFixed(1)}%) = ${(base*100).toFixed(1)}%`,
          source: "ftaCountries"
        });
        totalRate += base;
        warnings.push("‚ö†Ô∏è Minimum rate rule applies per rule set.");
      } else if (ftaInfo) {
        tariffItems.push({
          name: `${ftaInfo.fta} - Duty Free`,
          rate: 0,
          tag: "fta",
          description: ftaInfo.description || "0% duty-free",
          source: ftaInfo.fta
        });
      }

      // If not USMCA compliant duty-free base already added and waiveAll=true, skip everything
      // Otherwise, we still need MFN base when appropriate.
      const treatAsNoFta = (!hasFta) || (ftaInfo?.type === "conditional" && !usmcaCompliant);

      // ---- Step 2) Apply measures (MFN base + add-ons) with waivers
      if (!waiveAll) {
        const ctx = {
          hs10: code10,
          country,
          flags,
          hasFta: hasFta && !(ftaInfo?.type === "conditional" && !usmcaCompliant),
          mfnRate,
          recipRate
        };

        // Build list of candidate measures
        const measures = Array.isArray(RULES.measures) ? RULES.measures : [];

        // We always include MFN base when treatAsNoFta OR when FTA doesn't define base (standard FTA here keeps base 0)
        for (const m of measures) {
          if (m.kind === "base") {
            if (treatAsNoFta) {
              const r = measureRate(m, ctx);
              tariffItems.push({
                name: m.name,
                rate: r,
                tag: m.tag || "mfn",
                description: `From rules (mfnRates): ${(r*100).toFixed(1)}%`,
                source: m.id
              });
              totalRate += r;
            }
            continue;
          }

          // additive measures apply only if they match conditions
          if (m.kind === "additive") {
            if (!appliesWhen(m, { ...ctx, hasFta: !treatAsNoFta })) continue;
            // special: reciprocal applies only in treatAsNoFta unless rules says otherwise
            if (m.id === "reciprocal" && !treatAsNoFta) continue;

            const r = measureRate(m, ctx);
            if (r <= 0) continue;

            tariffItems.push({
              name: m.name,
              rate: r,
              tag: m.tag || "ieepa",
              description: "Applied per rules engine",
              source: m.id
            });
          }
        }

        // Apply waivers (if certain measure present -> remove waived measures)
        const presentIds = new Set(tariffItems.map(x => x.source).filter(Boolean));
        const waivers = Array.isArray(RULES.waivers) ? RULES.waivers : [];

        for (const w of waivers) {
          if (!presentIds.has(w.whenMeasureApplied)) continue;
          for (const wid of (w.waiveMeasures || [])) {
            // remove items whose source == wid
            const before = tariffItems.length;
            tariffItems = tariffItems.filter(x => x.source !== wid);
            const after = tariffItems.length;
            if (before !== after && w.note) exemptions.push(`‚úÖ ${w.note}`);
          }
        }

        // Recompute total from tariffItems (safe)
        totalRate = tariffItems.reduce((sum, x) => sum + (Number(x.rate) || 0), 0);
      }

      return { hsCode10: code10, description, countryCode: country, ftaStatusText, tariffItems, totalRate, warnings, exemptions };
    }

    // =========================
    // RESULTS RENDER
    // =========================
    function displayResults(data) {
      document.getElementById('displayHsCode').textContent = formatHsCode(data.hsCode10);
      document.getElementById('productCategory').textContent = data.description;
      document.getElementById('displayOrigin').textContent = getCountryLabel(data.countryCode);
      document.getElementById('ftaStatusResult').textContent = data.ftaStatusText;

      const totalBadge = document.getElementById('totalRate');
      totalBadge.textContent = (data.totalRate * 100).toFixed(1) + '%';
      if (data.totalRate === 0) totalBadge.classList.add('zero');
      else totalBadge.classList.remove('zero');

      let itemsHTML = '';
      data.tariffItems.forEach(item => {
        const tagHTML = item.tag ? `<span class="tag ${escapeHtml(item.tag)}">${escapeHtml(String(item.tag).toUpperCase())}</span>` : '';
        const isFree = item.rate === 0 ? ' free' : '';
        const rateClass = item.rate === 0 ? ' zero' : '';
        itemsHTML += `
          <div class="tariff-item${isFree}">
            <div class="tariff-header">
              <div class="tariff-name">${escapeHtml(item.name)} ${tagHTML}</div>
              <div class="tariff-rate${rateClass}">${(item.rate * 100).toFixed(1)}%</div>
            </div>
            <div class="tariff-description">
              ${escapeHtml(item.description || '')}<br>
              <small style="color:#64748b; font-size:12px; font-weight:900;">Rule key: ${escapeHtml(item.source || '')}</small>
            </div>
          </div>
        `;
      });
      document.getElementById('tariffItems').innerHTML = itemsHTML;

      document.getElementById('exemptionContainer').innerHTML = data.exemptions.length ? `
        <div class="exemption-box">
          <div class="exemption-title">‚úÖ Exemptions Applied</div>
          <div style="font-size:14px; color:#047857; line-height:1.6; font-weight:900;">
            ${data.exemptions.map(escapeHtml).join('<br>')}
          </div>
        </div>` : '';

      document.getElementById('warningContainer').innerHTML = data.warnings.length ? `
        <div class="warning-box">
          <div class="warning-title">‚ö†Ô∏è Important Notes</div>
          <div style="font-size:14px; color:#78350f; line-height:1.6; font-weight:900;">
            ${data.warnings.map(escapeHtml).join('<br>')}
          </div>
        </div>` : '';
    }

    // =========================
    // HISTORY
    // =========================
    let tariffChart = null;

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function saveHistory(arr) {
      try { localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); } catch {}
    }

    function recordHistory(data) {
      const arr = loadHistory();
      arr.unshift({ ts: new Date().toISOString(), hs: data.hsCode10, origin: data.countryCode, total: data.totalRate });
      saveHistory(arr.slice(0, HISTORY_MAX));
      renderHistory(loadHistory());
    }

    function renderHistory(arr) {
      const list = document.getElementById("timelineList");
      if (!list) return;

      if (!arr.length) {
        list.innerHTML = `<p class="muted">Search to view tariff history</p>`;
      } else {
        list.innerHTML = arr.map(x => {
          const d = new Date(x.ts);
          const when = isNaN(d.getTime()) ? x.ts : d.toLocaleString();
          return `
            <div style="background:#f7fafc; border:2px solid #e2e8f0; border-radius:12px; padding:12px; margin-bottom:10px;">
              <div style="font-weight:900; color:#1e293b; font-size:13px;">${escapeHtml(when)}</div>
              <div style="font-size:12px; color:#475569; font-weight:900; margin-top:6px;">
                ${escapeHtml(x.origin)} ‚Ä¢ ${escapeHtml(formatHsCode(String(x.hs)))} ‚Ä¢ <span style="font-weight:900;">${(Number(x.total)*100).toFixed(1)}%</span>
              </div>
            </div>
          `;
        }).join("");
      }

      renderChart(arr);
    }

    function renderChart(arr) {
      const canvas = document.getElementById("tariffChart");
      if (!canvas || !window.Chart) return;

      const labels = [...arr].reverse().map(x => {
        const d = new Date(x.ts);
        return isNaN(d.getTime()) ? "" : (String(d.getHours()).padStart(2,"0") + ":" + String(d.getMinutes()).padStart(2,"0"));
      });
      const data = [...arr].reverse().map(x => Number(x.total) * 100);

      if (tariffChart) tariffChart.destroy();

      tariffChart = new Chart(canvas, {
        type: "line",
        data: { labels, datasets: [{ label: "Total Tariff (%)", data, tension: 0.25 }] },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });
    }

    // =========================
    // MAIN ACTION
    // =========================
    async function lookupTariff() {
      const origin = document.getElementById('origin').value;
      const rawHs = document.getElementById('hsCode').value;
      const usmcaCompliant = document.getElementById('usmcaCompliant')?.checked || false;

      if (!RULES) { alert("Rules not loaded yet. Click Update."); return; }
      if (!origin) { alert("Select origin country."); return; }

      const hs = normalizeHs(rawHs);
      if (!hs || hs.length < 6) { alert("Enter HS code (min 6 digits)."); return; }

      document.getElementById('loading').classList.add('show');
      document.getElementById('results').classList.remove('show');
      await new Promise(r => setTimeout(r, 350));

      const result = calculateTariff(hs, origin, usmcaCompliant);
      displayResults(result);
      recordHistory(result);

      document.getElementById('loading').classList.remove('show');
      document.getElementById('results').classList.add('show');
    }

    // Enter key to calc
    document.getElementById('hsCode').addEventListener('keypress', e => {
      if (e.key === 'Enter') lookupTariff();
    });

    // INIT
    window.addEventListener('load', async () => {
      renderHistory(loadHistory());
      await refreshRules(false);
      setInterval(() => refreshRules(false), AUTO_REFRESH_MS);
      updateFtaStatus();
      displayNews();
    });
  </script>
</body>
</html>



